#! /usr/bin/env ruby
# See input/examples/README.md for more information

require 'yaml'
require 'json'
require 'pry'

examples_path = File.expand_path('../input/examples/', File.dirname(__FILE__))
pagecontent_path = File.expand_path('../input/pagecontent/', File.dirname(__FILE__))
examples_yaml = YAML.load_file(File.expand_path('../../examples.yaml', examples_path))

complete_shc_example_info = %Q{<!-- This file is automatically generated by script/update-examples-->\n\n<div class="alert alert-info"><strong>Note:</strong> Examples in this FHIR IG show just the FHIR resources used in a SMART Health Card. To view complete SMART Health Cards that include these FHIR resources, <a href="https://github.com/HL7/fhir-shc-vaccination-ig/tree/master-examples">see here</a>.</div>}

# Metadata to add to sushi_config.yaml
for_sushi_config = []
def sushi_config_entry(resource_type, example_id, canonical_of)
  return {
    type: resource_type,
    example_id: example_id,
    canonical_of: canonical_of
  }
end

def write_example(to_json, rewrite_resource_0_reference=false)
  path = File.expand_path("../input/examples/zzz-autogenerated-#{to_json['id']}.json", File.dirname(__FILE__))

  # Replace reference to Patient
  j = JSON.pretty_generate(to_json)
  j.gsub!('resource:0', 'example-patient-from-example-bundle-immunization-covid') if rewrite_resource_0_reference

  File.open(path, 'w') { |f| f.write(j) }
  return j
end

# Iterate through examples defined in the _examples.yaml config file
examples_yaml.each do |bundle_example, metadata|
  bundle_example_path = File.expand_path("#{bundle_example}.json", examples_path)

  # Assume disease is last word of bundle filename
  disease = bundle_example.match(/[^\-]*$/).to_s

  # Associate this example with the bundles
  # The first item in `exampleOf` will use `bundle_example_path`. Subsequent items will need a copy
  # of the example.
  metadata['exampleOf'].each_with_index do |example_of, i|
    # Reload file on each loop because we are going to modify the id element inside the Ruby object
    # This avoids having to worry about deep copying the object
    bundle_example_json = nil
    File.open(bundle_example_path) { |f| bundle_example_json = JSON.load(f) }

    based_on = nil
    if i > 0
      original_id = bundle_example_json['id']
      bundle_example_json['id'] = "#{bundle_example_json['id']}-#{i+1}"
      write_example(bundle_example_json)

      # Write intro Markdown page
      File.open(File.expand_path("Bundle-#{bundle_example_json['id']}-intro.md", pagecontent_path), 'w') do |f|
        f.write(complete_shc_example_info + %Q{\n\n\n<div class="alert alert-success" markdown="1">This example is a copy of [`#{original_id}`](Bundle-#{original_id}.html). See [here](https://github.com/HL7/fhir-shc-vaccination-ig/tree/master/input/examples) for more information.\n</div>})
      end
    else
      File.open(File.expand_path("Bundle-#{bundle_example_json['id']}-intro.md", pagecontent_path), 'w') do |f|
        f.write(complete_shc_example_info)
      end
    end

    File.open(File.expand_path("Bundle-#{bundle_example_json['id']}.json-intro.md", pagecontent_path), 'w') do |f|
      f.write(complete_shc_example_info)
    end

    for_sushi_config << sushi_config_entry('Bundle', bundle_example_json['id'], example_of)
  end

  # Extract examples from embedded resources
  metadata['embeddedResourceExampleOf'].each do |fhir_type, examples_of|
    examples_of.each_with_index do |example_of, i|
      # Reload file on each loop because we are going to modify the id element inside the Ruby object
      # This avoids having to worry about deep copying the object
      bundle_example_json = nil
      File.open(bundle_example_path) { |f| bundle_example_json = JSON.load(f) }

      # Loop through bundle to find examples of the right type
      resources = bundle_example_json['entry'].map { |e| e['resource'] }.select { |r| r['resourceType'] == fhir_type }
      resources.each_with_index do |resource, j|
        resource['id'] = "example-#{fhir_type.downcase}-#{disease}-#{j+1}#{('a'..'z').to_a[i]}"
        output_json = write_example(resource, rewrite_resource_0_reference=false)
        for_sushi_config << sushi_config_entry(fhir_type, resource['id'], example_of)

        # Write intro Markdown page - also include JSON because for some reason the Publisher shows
        # no content on the main example page.
        File.open(File.expand_path("#{fhir_type}-#{resource['id']}-intro.md", pagecontent_path), 'w') do |f|
          f.write(%Q{<!-- This file is automatically generated by script/update-examples-->\n\n<div class="alert alert-success" markdown="1">**Note:** This example is extracted from [`#{bundle_example_json['id']}`](Bundle-#{bundle_example_json['id']}.html). See [here](https://github.com/HL7/fhir-shc-vaccination-ig/tree/master/input/examples) for more information.\n</div>\n\n```\n#{output_json.gsub(/,\n  "id":.*/,'')}\n```})
        end

        # Write intro Markdown page for *.json.html to warn about the "reference"
        # Currently not used because `rewrite_resource_0_reference=false` above -- but if we have to
        # change this becuase of IG publisher errors, it's ready to go.
        if(output_json.include? '"reference": "example-patient')
          File.open(File.expand_path("#{fhir_type}-#{resource['id']}.json-intro.md", pagecontent_path), 'w') do |f|
            f.write(%Q{<!-- This file is automatically generated by script/update-examples-->\n\n<div class="alert alert-warning"><strong>Warning!</strong> Due to a limitation in the <a href="https://confluence.hl7.org/display/FHIR/IG+Publisher+Documentation">FHIR IG Publisher</a> used to generate this page, the JSON below <strong>does not</strong> use the proper <code>resource:N</code> syntax for referencing a Patient resource. See <a href="">here</a> for a version of this example with the proper syntax.</div>})
          end
        end
      end
    end
  end
end


# Update sushi-config.yaml
sushi_config_path = File.expand_path('../sushi-config.yaml', File.dirname(__FILE__))
sushi_config = YAML.load_file(sushi_config_path)

# Parse parameters.no-narrative, keep any non-example entries
no_narrative = sushi_config['parameters']['no-narrative'].select{ |o| !o.include?('/example')}
# Add all examples
sushi_config['parameters']['no-narrative'] = no_narrative.concat(for_sushi_config.map { |c| "#{c[:type]}/#{c[:example_id]}" } )

# Parse parameters.suppressed-ids, keep any non-example entries
suppress_ids = sushi_config['parameters']['suppressed-ids'].split(',')
suppress_ids = suppress_ids.select { |o| !o.match(/^example-/) }
sushi_config['parameters']['suppressed-ids'] = suppress_ids.concat(for_sushi_config.map { |c| c[:example_id] } ).join(',')

# Update resources hash
for_sushi_config.each do |e|
  key = "#{e[:type]}/#{e[:example_id]}"
  sushi_config['resources'] ||= {}
  sushi_config['resources'][key] ||= {}
  sushi_config['resources'][key]['exampleCanonical'] = 'http://hl7.org/fhir/uv/shc-vaccination/StructureDefinition/'+e[:canonical_of]
  sushi_config['resources'][key]['description'] = 'Generated example for '+e[:canonical_of]

  # Generate intro page
  File.open(File.expand_path("StructureDefinition-#{e[:canonical_of]}-examples-intro.md", pagecontent_path), 'w') do |f|
    f.write(complete_shc_example_info)
  end
end

File.open(sushi_config_path, 'w') do |f|
  YAML.dump(sushi_config, f)
end

puts "#{for_sushi_config.length} example(s) processed and added to sushi_config.yaml."
