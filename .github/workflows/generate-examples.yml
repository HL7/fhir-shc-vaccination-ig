name: Generate examples

on:
  push:
    branches:
      - master
      - temp-examples-in-ig-2022-07-20
    paths:
      - 'input/examples/**'

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

jobs:
  test:
    name: Generate examples
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3
      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: 2.7
          bundler-cache: true # runs 'bundle install' and caches installed gems automatically
      - name: Run Ruby generate-examples
        run: |
          cd input/examples
          gem install health_cards -v '~> 1.0'
          ruby $GITHUB_WORKSPACE/script/generate-examples.rb
      - name: Check out master-examples branch as worktree
        run: |
          # setup the username and email
          git config user.name "GitHub Actions Bot"
          git config user.email "<>"

          # Open `master-examples` branch as a worktree folder
          git fetch origin
          git worktree add --track -b master-examples $GITHUB_WORKSPACE/../master-examples origin/master-examples
          cd $GITHUB_WORKSPACE/../master-examples

          # Move generated files in
          mv README.md ..
          rm *
          mv ../README.md .
          cp $GITHUB_WORKSPACE/input/examples/* .

          # Stage files and amend the previous commit (to avoid repo bloat)
          git add -A
          git commit --amend -m "Examples"
          GIT_SSH_COMMAND='ssh -i ' git push -u --force origin master-examples